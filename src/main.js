const imageLibrary = {
  labrador: [
    'https://images.dog.ceo/breeds/labrador/n02099712_3707.jpg',
    'https://images.dog.ceo/breeds/labrador/n02099712_2224.jpg',
    'https://images.dog.ceo/breeds/labrador/n02099712_643.jpg',
    'https://images.dog.ceo/breeds/labrador/n02099712_6823.jpg',
    'https://images.dog.ceo/breeds/labrador/n02099712_1164.jpg',
  ],
  germanshepherd: [
    'https://images.dog.ceo/breeds/germanshepherd/n02106662_1239.jpg',
    'https://images.dog.ceo/breeds/germanshepherd/n02106662_5560.jpg',
    'https://images.dog.ceo/breeds/germanshepherd/n02106662_3652.jpg',
    'https://images.dog.ceo/breeds/germanshepherd/n02106662_6008.jpg',
    'https://images.dog.ceo/breeds/germanshepherd/n02106662_791.jpg',
  ],
  beagle: [
    'https://images.dog.ceo/breeds/beagle/n02088364_11136.jpg',
    'https://images.dog.ceo/breeds/beagle/n02088364_1578.jpg',
    'https://images.dog.ceo/breeds/beagle/n02088364_15437.jpg',
    'https://images.dog.ceo/breeds/beagle/n02088364_11102.jpg',
    'https://images.dog.ceo/breeds/beagle/n02088364_15037.jpg',
  ],
  indie: [
    'https://images.unsplash.com/photo-1525253086316-d0c936c814f8?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1549333574-98c51c7b53ee?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1548191265-cc70d3d45ba1?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1521302080379-7b01dab0c5b4?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1507146426996-ef05306b995a?auto=format&fit=crop&w=1200&q=80&sat=-15',
  ],
  persian: [
    'https://cdn2.thecatapi.com/images/0XYvRd7oD.jpg',
    'https://cdn2.thecatapi.com/images/9k.jpg',
    'https://cdn2.thecatapi.com/images/MTk4NjA3NQ.jpg',
    'https://cdn2.thecatapi.com/images/9og.jpg',
    'https://cdn2.thecatapi.com/images/bpc.jpg',
  ],
  siamese: [
    'https://cdn2.thecatapi.com/images/ai4JPS4sx.jpg',
    'https://cdn2.thecatapi.com/images/9rm.jpg',
    'https://cdn2.thecatapi.com/images/9m9.jpg',
    'https://cdn2.thecatapi.com/images/ai6JPS4sx.jpg',
    'https://cdn2.thecatapi.com/images/MTY3ODIyMQ.jpg',
  ],
  ragdoll: [
    'https://cdn2.thecatapi.com/images/LY4e1eCzf.jpg',
    'https://cdn2.thecatapi.com/images/LY4e1eCzQ.jpg',
    'https://cdn2.thecatapi.com/images/8is.jpg',
    'https://cdn2.thecatapi.com/images/mtQx8RW5W.jpg',
    'https://cdn2.thecatapi.com/images/13f.jpg',
  ],
  cockatiel: [
    'https://images.unsplash.com/photo-1508672019048-805c876b67e2?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1498579809087-ef1e558fd1da?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1484406566174-9da000fda645?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1508186225823-0963cf9ab0de?auto=format&fit=crop&w=1200&q=80',
  ],
  budgerigar: [
    'https://images.unsplash.com/photo-1484406566174-9da000fda645?auto=format&fit=crop&w=1200&q=80&sat=-5',
    'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=1200&q=80&sat=-5',
    'https://images.unsplash.com/photo-1508672019048-805c876b67e2?auto=format&fit=crop&w=1200&q=80&sat=-5',
    'https://images.unsplash.com/photo-1498579809087-ef1e558fd1da?auto=format&fit=crop&w=1200&q=80&sat=-5',
    'https://images.unsplash.com/photo-1508186225823-0963cf9ab0de?auto=format&fit=crop&w=1200&q=80&sat=-5',
  ],
  koi: [
    'https://images.unsplash.com/photo-1544551763-46a013bb70d5?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1470115636492-6d2b56f9146e?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=1200&q=80&sat=-30',
    'https://images.unsplash.com/photo-1470115636492-6d2b56f9146e?auto=format&fit=crop&w=1200&q=80&sat=-15',
  ],
  goldfish: [
    'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=1200&q=80&sat=5',
    'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=1200&q=80&sat=5',
    'https://images.unsplash.com/photo-1544551763-46a013bb70d5?auto=format&fit=crop&w=1200&q=80&sat=10',
    'https://images.unsplash.com/photo-1470115636492-6d2b56f9146e?auto=format&fit=crop&w=1200&q=80&sat=5',
    'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=1200&q=80&sat=-5',
  ],
  syrianhamster: [
    'https://images.unsplash.com/photo-1508182311256-e3f7d50c8cbe?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1508614589041-895b88991e3e?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1511300636408-a63a89df3482?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1453227588063-bb302b62f50b?auto=format&fit=crop&w=1200&q=80',
    'https://images.unsplash.com/photo-1504208434309-cb69f4fe52b0?auto=format&fit=crop&w=1200&q=80',
  ],
  netherlanddwarf: [
    'https://images.unsplash.com/photo-1508614589041-895b88991e3e?auto=format&fit=crop&w=1200&q=80&sat=-5',
    'https://images.unsplash.com/photo-1508182311256-e3f7d50c8cbe?auto=format&fit=crop&w=1200&q=80&sat=-5',
    'https://images.unsplash.com/photo-1511300636408-a63a89df3482?auto=format&fit=crop&w=1200&q=80&sat=-5',
    'https://images.unsplash.com/photo-1504208434309-cb69f4fe52b0?auto=format&fit=crop&w=1200&q=80&sat=-5',
    'https://images.unsplash.com/photo-1453227588063-bb302b62f50b?auto=format&fit=crop&w=1200&q=80&sat=-5',
  ],
  leopardgecko: [
    'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=1200&q=80&sat=-40',
    'https://images.unsplash.com/photo-1498579809087-ef1e558fd1da?auto=format&fit=crop&w=1200&q=80&sat=-20',
    'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=1200&q=80&sat=-20',
    'https://images.unsplash.com/photo-1508186225823-0963cf9ab0de?auto=format&fit=crop&w=1200&q=80&sat=-25',
    'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=1200&q=80&sat=-10',
  ],
  sugar: [
    'https://images.unsplash.com/photo-1508614589041-895b88991e3e?auto=format&fit=crop&w=1200&q=80&sat=-8',
    'https://images.unsplash.com/photo-1508182311256-e3f7d50c8cbe?auto=format&fit=crop&w=1200&q=80&sat=-8',
    'https://images.unsplash.com/photo-1511300636408-a63a89df3482?auto=format&fit=crop&w=1200&q=80&sat=-8',
    'https://images.unsplash.com/photo-1453227588063-bb302b62f50b?auto=format&fit=crop&w=1200&q=80&sat=-8',
    'https://images.unsplash.com/photo-1504208434309-cb69f4fe52b0?auto=format&fit=crop&w=1200&q=80&sat=-8',
  ],
};

function getImages(key, fallbackQuery) {
  if (imageLibrary[key]) return imageLibrary[key];
  const query = fallbackQuery || key;
  return Array.from({ length: 5 }, (_, i) => `https://source.unsplash.com/900x700/?${encodeURIComponent(query)}&sig=${i}`);
}

const petData = [
  {
    id: 1,
    species: 'Dog',
    breed: 'Labrador Retriever',
    gender: 'female',
    ageMonths: 5,
    colour: 'Golden',
    city: 'Bengaluru',
    state: 'Karnataka',
    price: 32000,
    badges: ['Microchipped', 'DHPPiL', 'KC registered'],
    logistics: 'Hand-off with vet',
    images: getImages('labrador', 'labrador retriever dog'),
  },
  {
    id: 2,
    species: 'Dog',
    breed: 'German Shepherd',
    gender: 'male',
    ageMonths: 11,
    colour: 'Black & Tan',
    city: 'Pune',
    state: 'Maharashtra',
    price: 42000,
    badges: ['Hip score', 'Microchipped', 'Trainer ready'],
    logistics: 'City pickup',
    images: getImages('germanshepherd', 'german shepherd dog'),
  },
  {
    id: 3,
    species: 'Dog',
    breed: 'Indie (Desi)',
    gender: 'female',
    ageMonths: 4,
    colour: 'Tricolour',
    city: 'Delhi',
    state: 'Delhi',
    price: 9000,
    badges: ['Adoption-first', 'Vaccinated'],
    logistics: 'Foster to adopt',
    images: getImages('indie', 'indian pariah dog'),
  },
  {
    id: 4,
    species: 'Cat',
    breed: 'Persian',
    gender: 'male',
    ageMonths: 8,
    colour: 'White',
    city: 'Mumbai',
    state: 'Maharashtra',
    price: 28000,
    badges: ['FVRCP', 'Indoor only'],
    logistics: 'Home delivery',
    images: getImages('persian', 'persian cat'),
  },
  {
    id: 5,
    species: 'Cat',
    breed: 'Siamese',
    gender: 'female',
    ageMonths: 14,
    colour: 'Seal Point',
    city: 'Jaipur',
    state: 'Rajasthan',
    price: 24000,
    badges: ['Spay scheduled', 'Microchipped'],
    logistics: 'Live video check',
    images: getImages('siamese', 'siamese cat'),
  },
  {
    id: 6,
    species: 'Bird',
    breed: 'Cockatiel',
    gender: 'female',
    ageMonths: 10,
    colour: 'Lutino',
    city: 'Chennai',
    state: 'Tamil Nadu',
    price: 6000,
    badges: ['Exotic declared', 'Closed ring'],
    logistics: 'Courier-safe crate',
    images: getImages('cockatiel', 'cockatiel bird'),
  },
  {
    id: 7,
    species: 'Bird',
    breed: 'Budgerigar',
    gender: 'male',
    ageMonths: 6,
    colour: 'Sky Blue',
    city: 'Kochi',
    state: 'Kerala',
    price: 2200,
    badges: ['Paired option', 'Exotic declared'],
    logistics: 'Courier-safe crate',
    images: getImages('budgerigar', 'budgerigar bird'),
  },
  {
    id: 8,
    species: 'Aquatic',
    breed: 'Koi Carp',
    gender: 'female',
    ageMonths: 18,
    colour: 'Kohaku',
    city: 'Surat',
    state: 'Gujarat',
    price: 15000,
    badges: ['O2 packed', 'Live arrival'],
    logistics: 'Temperature control',
    images: getImages('koi', 'koi carp fish'),
  },
  {
    id: 9,
    species: 'Aquatic',
    breed: 'Goldfish',
    gender: 'male',
    ageMonths: 9,
    colour: 'Calico',
    city: 'Lucknow',
    state: 'Uttar Pradesh',
    price: 1800,
    badges: ['Permitted list', 'O2 packed'],
    logistics: 'Same-day courier',
    images: getImages('goldfish', 'goldfish aquarium'),
  },
  {
    id: 10,
    species: 'Small Pet',
    breed: 'Syrian Hamster',
    gender: 'female',
    ageMonths: 3,
    colour: 'Golden',
    city: 'Hyderabad',
    state: 'Telangana',
    price: 1800,
    badges: ['Starter kit', 'Care sheet'],
    logistics: 'City pickup',
    images: getImages('syrianhamster', 'syrian hamster'),
  },
  {
    id: 11,
    species: 'Small Pet',
    breed: 'Netherland Dwarf Rabbit',
    gender: 'male',
    ageMonths: 7,
    colour: 'Grey',
    city: 'Chandigarh',
    state: 'Chandigarh',
    price: 6500,
    badges: ['Vet cleared', 'Litter trained'],
    logistics: 'Hand-off with vet',
    images: getImages('netherlanddwarf', 'netherland dwarf rabbit'),
  },
  {
    id: 12,
    species: 'Reptile',
    breed: 'Leopard Gecko',
    gender: 'female',
    ageMonths: 12,
    colour: 'High Yellow',
    city: 'Pune',
    state: 'Maharashtra',
    price: 9000,
    badges: ['Captive bred', 'CITES docs'],
    logistics: 'Specialist courier',
    images: getImages('leopardgecko', 'leopard gecko'),
  },
  {
    id: 13,
    species: 'Dog',
    breed: 'Beagle',
    gender: 'male',
    ageMonths: 9,
    colour: 'Tri-colour',
    city: 'Bhopal',
    state: 'Madhya Pradesh',
    price: 27000,
    badges: ['Vaccinated', 'Socialized'],
    logistics: 'Home delivery',
    images: getImages('beagle', 'beagle dog'),
  },
  {
    id: 14,
    species: 'Cat',
    breed: 'Ragdoll',
    gender: 'female',
    ageMonths: 16,
    colour: 'Blue Bicolor',
    city: 'Kolkata',
    state: 'West Bengal',
    price: 32000,
    badges: ['FeLV clear', 'Indoor only'],
    logistics: 'Live video check',
    images: getImages('ragdoll', 'ragdoll cat'),
  },
  {
    id: 15,
    species: 'Small Pet',
    breed: 'Sugar Glider',
    gender: 'male',
    ageMonths: 10,
    colour: 'Classic Grey',
    city: 'Ahmedabad',
    state: 'Gujarat',
    price: 22000,
    badges: ['Declared exotic', 'Pair ready'],
    logistics: 'Specialist courier',
    images: getImages('sugar', 'sugar glider'),
  },
];

const speciesSelect = document.getElementById('filter-species');
const breedSelect = document.getElementById('filter-breed');
const genderSelect = document.getElementById('filter-gender');
const ageSelect = document.getElementById('filter-age');
const colourSelect = document.getElementById('filter-colour');
const stateSelect = document.getElementById('filter-state');
const resetButton = document.getElementById('reset-filters');
const gridEl = document.getElementById('pet-grid');
const resultsCountEl = document.getElementById('results-count');
const cartCountEl = document.getElementById('cart-count');
const lightboxEl = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightbox-image');
const lightboxCaption = document.getElementById('lightbox-caption');
const lightboxPrev = document.getElementById('lightbox-prev');
const lightboxNext = document.getElementById('lightbox-next');
const lightboxClose = document.querySelector('.lightbox__close');
const authModal = document.getElementById('auth-modal');
const authClose = document.getElementById('auth-close');
const authForm = document.getElementById('auth-form');
const authTitle = document.getElementById('auth-title');
const authRole = document.getElementById('auth-role');

const currency = new Intl.NumberFormat('en-IN', {
  style: 'currency',
  currency: 'INR',
  maximumFractionDigits: 0,
});

let cart = [];
let lightboxState = { petId: null, index: 0 };

function unique(values) {
  return [...new Set(values)].sort();
}

function populateSelect(select, options, { includeAll = true, allLabel = 'Any' } = {}) {
  const fragment = document.createDocumentFragment();
  if (includeAll) {
    const opt = document.createElement('option');
    opt.value = 'all';
    opt.textContent = allLabel;
    fragment.appendChild(opt);
  }

  options.forEach((value) => {
    const opt = document.createElement('option');
    opt.value = value;
    opt.textContent = value;
    fragment.appendChild(opt);
  });

  select.innerHTML = '';
  select.appendChild(fragment);
}

function ageLabel(months) {
  if (months < 12) return `${months} mo`;
  const years = months / 12;
  if (years < 2) return `${years.toFixed(1)} yr`;
  return `${years.toFixed(1)} yrs`;
}

function matchesAge(pet, band) {
  if (band === 'all') return true;
  const [min, max] = band === '36+'
    ? [36, Infinity]
    : band.split('-').map((v) => Number(v));
  return pet.ageMonths >= min && pet.ageMonths <= max;
}

function applyFilters() {
  const species = speciesSelect.value;
  const breed = breedSelect.value;
  const gender = genderSelect.value;
  const ageBand = ageSelect.value;
  const colour = colourSelect.value;
  const state = stateSelect.value;

  const filtered = petData.filter((pet) => {
    return (
      (species === 'all' || pet.species === species) &&
      (breed === 'all' || pet.breed === breed) &&
      (gender === 'all' || pet.gender === gender) &&
      (colour === 'all' || pet.colour === colour) &&
      (state === 'all' || pet.state === state) &&
      matchesAge(pet, ageBand)
    );
  });

  renderCards(filtered);
  resultsCountEl.textContent = `${filtered.length} companion${filtered.length === 1 ? '' : 's'}`;
}

function renderCards(list) {
  if (!list.length) {
    gridEl.innerHTML = '<p class="empty">No listings match these filters. Try widening your search.</p>';
    return;
  }

  const html = list
    .map(
      (pet) => `
        <article class="pet-card">
          <img class="pet-photo" src="${pet.images[0]}" alt="${pet.breed}" loading="lazy" />
          <div class="pet-card__header">
            <span class="pill">${pet.species}</span>
            <span class="pill pill-ghost">${pet.logistics}</span>
          </div>
          <h3>${pet.breed}</h3>
          <p class="meta">${pet.gender === 'female' ? 'Female' : 'Male'} · ${ageLabel(pet.ageMonths)} · ${pet.colour}</p>
          <p class="location">${pet.city}, ${pet.state}</p>
          <div class="badge-row">
            ${pet.badges.map((b) => `<span class="mini-badge">${b}</span>`).join('')}
          </div>
          <div class="card-footer">
            <div>
              <p class="price">${currency.format(pet.price)}</p>
              <p class="hint">Health card before payment</p>
            </div>
            <div class="card-actions">
              <button class="ghost small" data-photos="${pet.id}">View photos</button>
              <button class="ghost small" data-add="${pet.id}">Add to cart</button>
              <button class="solid small" data-buy="${pet.id}">Buy now</button>
            </div>
          </div>
        </article>
      `,
    )
    .join('');

  gridEl.innerHTML = html;

  gridEl.querySelectorAll('[data-add]').forEach((btn) => {
    btn.addEventListener('click', () => addToCart(Number(btn.dataset.add)));
  });
  gridEl.querySelectorAll('[data-buy]').forEach((btn) => {
    btn.addEventListener('click', () => buyNow(Number(btn.dataset.buy)));
  });
  gridEl.querySelectorAll('[data-photos]').forEach((btn) => {
    btn.addEventListener('click', () => openLightbox(Number(btn.dataset.photos), 0));
  });
}

function updateBreedOptions() {
  const species = speciesSelect.value;
  const breeds = species === 'all'
    ? unique(petData.map((p) => p.breed))
    : unique(petData.filter((p) => p.species === species).map((p) => p.breed));
  populateSelect(breedSelect, breeds, { includeAll: true, allLabel: 'All breeds' });
}

function hydrateFilters() {
  populateSelect(speciesSelect, unique(petData.map((p) => p.species)), { allLabel: 'All species' });
  updateBreedOptions();
  populateSelect(colourSelect, unique(petData.map((p) => p.colour)), { allLabel: 'Any colour' });
  populateSelect(stateSelect, unique(petData.map((p) => p.state)), { allLabel: 'Any state' });
}

function attachEvents() {
  speciesSelect.addEventListener('change', () => {
    updateBreedOptions();
    applyFilters();
  });

  [breedSelect, genderSelect, ageSelect, colourSelect, stateSelect].forEach((el) =>
    el.addEventListener('change', applyFilters),
  );

  resetButton.addEventListener('click', () => {
    speciesSelect.value = 'all';
    genderSelect.value = 'all';
    ageSelect.value = 'all';
    colourSelect.value = 'all';
    stateSelect.value = 'all';
    updateBreedOptions();
    breedSelect.value = 'all';
    applyFilters();
  });

  document.querySelectorAll('[data-scroll]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const target = document.querySelector(btn.dataset.scroll);
      if (target) target.scrollIntoView({ behavior: 'smooth' });
    });
  });

  document.querySelectorAll('[data-auth]').forEach((btn) => {
    btn.addEventListener('click', () => openAuthModal(btn.dataset.auth));
  });

  document.querySelectorAll('[data-contact]').forEach((btn) => {
    btn.addEventListener('click', () => alert('We will connect you to a live video check once login is enabled.'));
  });

  lightboxPrev.addEventListener('click', () => stepLightbox(-1));
  lightboxNext.addEventListener('click', () => stepLightbox(1));
  lightboxClose.addEventListener('click', closeLightbox);
  lightboxEl.addEventListener('click', (e) => {
    if (e.target === lightboxEl) closeLightbox();
  });

  authClose.addEventListener('click', closeAuthModal);
  authModal.addEventListener('click', (e) => {
    if (e.target === authModal) closeAuthModal();
  });
  authForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const role = authRole.value;
    closeAuthModal();
    alert(`${role === 'seller' ? 'Seller' : 'Buyer'} login placeholder. Hook this to your auth backend.`);
  });
}

function cycleFrames() {
  const frames = Array.from(document.querySelectorAll('.remotion-strip .frame'));
  let index = 0;
  if (!frames.length) return;
  frames[index].classList.add('active');

  setInterval(() => {
    frames[index].classList.remove('active');
    index = (index + 1) % frames.length;
    frames[index].classList.add('active');
  }, 2600);
}

function addToCart(petId) {
  if (!cart.includes(petId)) {
    cart.push(petId);
  }
  updateCartCount();
}

function buyNow(petId) {
  addToCart(petId);
  alert('Proceeding to checkout for pet ID ' + petId + '. Connect this to your payment flow.');
}

function updateCartCount() {
  cartCountEl.textContent = cart.length;
}

function openLightbox(petId, index) {
  const pet = petData.find((p) => p.id === petId);
  if (!pet) return;
  lightboxState = { petId, index };
  const imgUrl = pet.images[index % pet.images.length];
  lightboxImg.src = imgUrl;
  lightboxImg.alt = `${pet.breed} photo ${index + 1}`;
  lightboxCaption.textContent = `${pet.breed} — ${index + 1} / ${pet.images.length}`;
  lightboxEl.classList.remove('hidden');
}

function closeLightbox() {
  lightboxEl.classList.add('hidden');
}

function stepLightbox(delta) {
  const pet = petData.find((p) => p.id === lightboxState.petId);
  if (!pet) return;
  const nextIndex = (lightboxState.index + delta + pet.images.length) % pet.images.length;
  openLightbox(pet.id, nextIndex);
}

function openAuthModal(role = 'buyer') {
  authTitle.textContent = role === 'seller' ? 'Seller Portal Login' : 'Buyer Login';
  authRole.value = role;
  authModal.classList.remove('hidden');
}

function closeAuthModal() {
  authModal.classList.add('hidden');
}

hydrateFilters();
attachEvents();
applyFilters();
cycleFrames();
